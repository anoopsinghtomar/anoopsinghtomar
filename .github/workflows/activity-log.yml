name: Generate Private JSON Activity Log

on:
  schedule:
    - cron: "0 0 * * 0"   # Weekly (Sunday)
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD)"
        required: false
      end_date:
        description: "End date (YYYY-MM-DD)"
        required: false

jobs:
  generate-log:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Set Date Range
        id: daterange
        run: |
          if [ -n "${{ github.event.inputs.start_date }}" ]; then
            START="${{ github.event.inputs.start_date }}"
            END="${{ github.event.inputs.end_date }}"
          else
            END=$(date -u +"%Y-%m-%d")
            START=$(date -u -d "15 days ago" +"%Y-%m-%d")
          fi

          echo "START_DATE=$START" >> $GITHUB_ENV
          echo "END_DATE=$END" >> $GITHUB_ENV

      - name: Generate JSON Activity Log
        env:
          GH_PAT: ${{ secrets.METRICS_CLASSIC_TOKEN }}
        run: |
          OUTPUT="activity-log-$(date +'%d-%m-%Y').json"
          echo "[]" > $OUTPUT

          page=1
          repos=()

          while :
          do
            response=$(curl -s -H "Authorization: token $GH_PAT" \
              "https://api.github.com/user/repos?per_page=100&page=$page")

            count=$(echo "$response" | jq length)
            if [ "$count" -eq 0 ]; then
              break
            fi

            repos+=($(echo "$response" | jq -r '.[].full_name'))
            page=$((page+1))
          done

          for repo in "${repos[@]}"
          do
            commit_page=1

            while :
            do
              commits=$(curl -s -H "Authorization: token $GH_PAT" \
                "https://api.github.com/repos/$repo/commits?author=anoopsinghtomar&since=${START_DATE}T00:00:00Z&until=${END_DATE}T23:59:59Z&per_page=100&page=$commit_page")

              commit_count=$(echo "$commits" | jq length)
              if [ "$commit_count" -eq 0 ]; then
                break
              fi

              echo "$commits" | jq -c --arg repo "$repo" '.[] | {
                repository: $repo,
                commit_message: .commit.message,
                author: .commit.author.name,
                date: .commit.author.date,
                url: .html_url
              }' | jq -s '.' > temp.json

              jq -s 'add' $OUTPUT temp.json > merged.json
              mv merged.json $OUTPUT
              rm temp.json

              commit_page=$((commit_page+1))
            done
          done

          echo "OUTPUT_FILE=$OUTPUT" >> $GITHUB_ENV

      - name: Clone Private Repo
        env:
          GH_PAT: ${{ secrets.METRICS_CLASSIC_TOKEN }}
        run: |
          git clone https://x-access-token:$GH_PAT@github.com/anoopsinghtomar/learning-resources.git
          cd learning-resources
          mkdir -p activityFile
          cp ../$OUTPUT_FILE activityFile/
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add activityFile/$OUTPUT_FILE
          git commit -m "Add activity log $OUTPUT_FILE"
          git push
